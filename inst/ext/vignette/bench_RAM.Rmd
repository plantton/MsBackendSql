---
title: "A simple SQL-backend for Spectra metadata" 
author: "Laurent Gatto, Chong Tang"
output: 
    BiocStyle::html_document:
        toc_float: true
---

```{r style, echo = FALSE, results = 'asis', message = FALSE}
BiocStyle::markdown()
```

# Introduction

In this vignette, we want to benchmark 2 backends for the package `Spectra`:
`MsBackendSql` and `MsBackendMzR`, to evaluate whether the new backend 
`MsBackendSql` can reduce the RAM consumption.

# Usage

We will need the following packages:

```{r env, message = FALSE}
library(MsBackendSql)
library(Spectra)
library(mzR)
library(RSQLite)
library(msdata)
library(peakRAM)
library(tidyverse)
library(pryr)
```

The example below demonstrates the functionality of `MsBackendSql` with a single 
file:

```{r usage1, warning = FALSE}
f <- msdata::proteomics(full.names = TRUE)[4]
conn1 <- dbConnect(SQLite(), "b1.db")
b1 <- backendInitialize(MsBackendSqlDb(), dbcon = conn1, files = f)
object_size(b1)
```

We can also load the raw `mzML` file with `MsBackendMzR` backend.

```{r usage2}
b2 <- Spectra::backendInitialize(MsBackendMzR(), files = f)
object_size(b2)
```


# Benchmarking

In the code chunks below, we open respectively 1, 10, 20, 50, 100 and
200 times the same file and record the elapsed time (in seconds), the
peak amount of RAM used (MiB) and the amount of RAM used after
completion of the function:

```{r bench1, cache=TRUE}
conn1 <- dbConnect(SQLite(), "bench1.db")
peakram1 <- peakRAM(sqlb1 <- backendInitialize(MsBackendSqlDb(), dbcon = conn1, files = f))
conn10 <- dbConnect(SQLite(), "bench10.db")
peakram10 <- peakRAM(sqlb10 <- backendInitialize(MsBackendSqlDb(), dbcon = conn10, rep(f, 10)))
conn20 <- dbConnect(SQLite(), "bench20.db")
peakram20 <- peakRAM(sqlb20 <- backendInitialize(MsBackendSqlDb(), dbcon = conn20, rep(f, 20)))
conn50 <- dbConnect(SQLite(), "bench50.db")
peakram50 <- peakRAM(sqlb50 <- backendInitialize(MsBackendSqlDb(), dbcon = conn50, rep(f, 50)))
conn100 <- dbConnect(SQLite(), "bench100.db")
peakram100 <- peakRAM(sqlb100 <- backendInitialize(MsBackendSqlDb(), dbcon = conn100, rep(f, 100)))
conn200 <- dbConnect(SQLite(), "bench200.db")
peakram200 <- peakRAM(sqlb200 <- backendInitialize(MsBackendSqlDb(), dbcon = conn200, rep(f, 200)))

n <- c(1, 10, 20, 50, 100, 200)

res1 <- vector(mode = "list", length = 6)
for (i in seq_along(n)) {
    fls  <-  rep(f, n[i])
    res1[[i]] <- peakRAM(b1 <- Spectra::backendInitialize(MsBackendMzR(), files = fls))
}

save(peakram1, peakram10, peakram20,
     peakram50, peakram100, peakram200, res1,
     file = "peakRAM_SQL.rda")
```


We repeatedly stored the metadata as SQLite tables in the following
SQLite databases. Below, we retrieved each single metadata table in
the SQLite database, and checked their RAM consumptions (MiB) and the
file size (MB).

```{r bench2, cache = TRUE}
db_files <- dir(pattern = "bench.*db")
db_files <- db_files[order(as.numeric(sub("\\.db", "", sub("bench", "", db_files))))]
dbfile_size <- file.size(db_files) / 1024^2
```

The benchmarking data:

```{r bench3, cache=TRUE}
load("peakRAM_SQL.rda")
dfr <- data.frame(rbind(peakram1, peakram10, peakram20,
                        peakram50, peakram100, peakram200),
                  dbfile_size,
                  n = c(1, 10, 20, 50, 100, 200)) %>%
    select(-1)
dfr
ram_records <- res1 %>% bind_rows(.)
dfr1 <- data.frame(rbind(peakram1, peakram10, peakram20,
                        peakram50, peakram100, peakram200), 
                        ram_records[-1],
                   n = c(1, 10, 20, 50, 100, 200)) %>%
    select(-1)
dfr1
```

# Results

Firstly, we want to compare the RAM consumptions with the local on-disk SQL 
database sizes.

```{r benchfig1, fig.wide = TRUE, cache=TRUE}
dfr %>%
    select(n, Total_RAM_Used_MiB, Peak_RAM_Used_MiB, dbfile_size) %>%
    pivot_longer(names_to = "param",
                 values_to = "value",
                 -n) %>%
    ggplot(aes(x = n, y = value, colour = param)) +
    geom_line() +
    geom_point()
```

Below, we also want to benchmark the differences between `MsBackendSql` and
`MsBackendMzR`. We can notice that `MsBackendMzR` is much faster than 
`MsBackendSql` for data reading.

```{r benchfig2, fig.wide = TRUE, cache=TRUE}
dfr1 %>%
    select(n, Elapsed_Time_sec_SQL = Elapsed_Time_sec, 
           Elapsed_Time_sec_mzR = Elapsed_Time_sec.1) %>%
    pivot_longer(names_to = "param",
                 values_to = "value",
                 -n) %>%
    ggplot(aes(x = n, y = value, colour = param)) +
    geom_line() +
    geom_point()
```

The total RAM consumption is also within our expectation, `MsBackendSql` 
backend can greatly reduce the RAM consumtion by storing metadata into SQLite
database.

```{r benchfig3, fig.wide = TRUE, cache=TRUE}
dfr1 %>%
        select(n, Total_RAM_Used_MiB_SQL = Total_RAM_Used_MiB, 
               Total_RAM_Used_MiB_mzR = Total_RAM_Used_MiB.1) %>%
        pivot_longer(names_to = "param",
                     values_to = "value",
                     -n) %>%
        ggplot(aes(x = n, y = value, colour = param)) +
        geom_line() +
        geom_point()
```

The final plot shows that the new backend `MsBackendSql` requires more RAM 
consumption on the peak than `MsBackendMzR`. 

```{r benchfig4, fig.wide = TRUE, cache=TRUE}
dfr1 %>%
        select(n, Peak_RAM_Used_MiB_SQL = Peak_RAM_Used_MiB, 
               Peak_RAM_Used_MiB_mzR = Peak_RAM_Used_MiB.1) %>%
        pivot_longer(names_to = "param",
                     values_to = "value",
                     -n) %>%
        ggplot(aes(x = n, y = value, colour = param)) +
        geom_line() +
        geom_point()
```

# Session information

```{r}
sessionInfo()
```